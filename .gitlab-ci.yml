stages:
  #- before-setup
  - setup
  - test
  - app-test
  - cleanup


job 1:
  image: atulabhi/kops:v2
  stage: setup
  script: 
    - set + x 
    - echo " job one success" > test.txt 
   # - python3 new_yml_creator.py
    - gcloud version
    - echo $SDK_TOKEN
    - echo $SDK_TOKEN > key.json
    - cat key.json
    - gcloud auth activate-service-account --key-file=key.json
    #- export GOOGLE_APPLICATION_CREDENTIALS=$SDK_TOKEN
    #- gcloud config set project openebs-ci
  artifacts:
    paths:
      - binary/

gcp-vpc:
  image: atulabhi/kops:v2
  stage: setup
  script: 
    - echo $SDK_TOKEN > key.json
    - gcloud auth activate-service-account --key-file=key.json
    - export GOOGLE_APPLICATION_CREDENTIALS=key.json
    - echo "creating vpc"
    - wget https://raw.githubusercontent.com/openebs/litmus/master/k8s/gcp/k8s-installer/create-vpc.yml
    - ansible-playbook create-vpc.yml --extra-vars "project=openebs-ci vpc_name=openebs-e2e-test" 
  artifacts:
    paths:
      - /test
gcp-cluster:
  image: atulabhi/kops:v5
  stage: setup
  script: 
    - echo "creating cluster"
    - echo $SDK_TOKEN > key.json
    - ls
    - cat key.json
    - pwd
    - ls
    - gcloud auth activate-service-account --key-file=key.json
    - gcloud config set project openebs-ci
    - export GOOGLE_APPLICATION_CREDENTIALS="/itsmesingh.avneet/e2e-infrastructure/key.json"
    - git clone https://github.com/harshvkarn/litmus.git 
    - cd litmus/
    - git checkout gcp-k8s
    - cd k8s/gcp/k8s-installer/
    - ansible-playbook create-k8s-cluster.yml -vv --extra-vars "project=openebs-ci nodes=3 vpc_name=openebs-e2e-test k8s_version=1.10.6"
    - echo $GOOGLE_APPLICATION_CREDENTIALS
    - gcloud auth list
    - pwd
    - mkdir /itsmesingh.avneet/e2e-infrastructure/.kube
    - cat ~/.kube/config > /itsmesingh.avneet/e2e-infrastructure/.kube/config
  artifacts:
    paths:
      - .kube/

openebs_gcp_deploy:
  image: atulabhi/kops:v5
  stage: test
  dependencies:
    - gcp-cluster
  script:
    - echo "Deploying Openebs"
    - ls -a
    - pwd
    - mkdir ~/.kube
    - cp  .kube/config ~/.kube/config
    - kubectl config get-contexts
  artifacts:
    paths:
      - .kube/

apps-deploy:
  stage: app-test
  script:
   - echo"Deploying apps"
   
  dependencies:
    - openebs_deploy
     

aws-prerequisite:
  image: atulabhi/kops:v5
  stage: setup
  script: 
   - echo "creating AWS vpc"
   - mkdir ~/.aws
   - echo $CONFIG ~/.aws/config
   - echo $CREDENTIALS ~/.aws/credentials
   - mkdir aws
   - git clone https://github.com/chandankumar4/test.git
   - cd test/k8s/aws/k8s-installer
   - ansible-playbook pre-requisite.yml
   - cp -r /tmp/aws/  /itsmesingh.avneet/e2e-infrastructure/aws/
  artifacts:
    paths:
      - aws/
      
aws-cluster:
  image: atulabhi/kops:v5
  stage: setup
  script:
   - echo "creating AWS cluster"
   - mkdir ~/.aws
   - echo  $CONFIG > ~/.aws/config
   - echo $CREDENTIALS > ~/.aws/credentials
   - ls
   - cp -r aws/ /tmp/aws/
   - git clone https://github.com/chandankumar4/test.git
   - cd test/k8s/aws/k8s-installer
   - ansible-playbook create-aws-cluster.yml --extra-vars "k8s_version=1.10.0"
   - cat ~/.kube/config > /itsmesingh.avneet/e2e-infrastructure/.kube/config
  artifacts:
    paths:
      - .kube/

openebs_aws_deploy:
  stage: test
  script: echo "job aws success"

apps-deploy:
  stage: app-test
  script: echo "job aws success"
 
